<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Vision Board üíö</title>
<meta name="robots" content="noindex,nofollow" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>
<style>
:root{
  color-scheme: dark;
  --bg: 12 14 14;
  --glass: 25 30 30 / .45;
  --mint: 130 255 210;
  --shadow-sm: 0 4px 18px rgba(0,0,0,.25);
  --shadow-md: 0 8px 26px rgba(0,0,0,.35);
  --shadow-lg: 0 18px 50px rgba(0,0,0,.55);
  --r-xl: 22px;
  --gap: 10px;

  --board-bg-1: #efe3d4;
  --board-bg-2: #e6d3bf;
  --board-stroke: rgba(92,62,41,.16);
  --tile-warm: #dcc8b5;
  --warm-text: #5a4a3c;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family:"Inter",system-ui,Segoe UI,Roboto,Arial,sans-serif;
  background: rgb(var(--bg)); color:#eafaf5;
  min-height:100svh; display:flex; justify-content:center; align-items:flex-start;
  padding:36px 18px;
}
.wrap{width:min(1100px,100%); display:flex; flex-direction:column; gap:18px}

.head{text-align:center}
.head h1{margin:0; font-size:clamp(26px,3.2vw,38px); color:rgb(var(--mint))}
.sub{margin:4px 0 0; color:#a9dcd0}
.toolbar{display:flex; gap:10px; flex-wrap:wrap; justify-content:center}
.btn{
  border:1px solid rgba(255,255,255,.14);
  background:linear-gradient(180deg, rgba(var(--glass)) 0%, rgba(var(--glass)) 100%);
  backdrop-filter: blur(16px) saturate(140%);
  -webkit-backdrop-filter: blur(16px) saturate(140%);
  color:#dffdf3; border-radius:999px; padding:10px 16px; font-weight:600; cursor:pointer;
  box-shadow:var(--shadow-md)
}
.btn:hover{filter:brightness(1.05)}
.btn.primary{ color:#0f1b17; background:rgb(var(--mint)); border-color:transparent }

.canvas{
  width:100%;
  background:
    radial-gradient(140% 120% at 0% 0%, rgba(255,255,255,.35) 0%, transparent 55%),
    radial-gradient(120% 110% at 100% 100%, rgba(255,255,255,.22) 0%, transparent 50%),
    linear-gradient(180deg, var(--board-bg-1), var(--board-bg-2));
  border:1px solid var(--board-stroke);
  border-radius: 18px;
  box-shadow: 0 18px 50px rgba(0,0,0,.30), inset 0 1px 0 rgba(255,255,255,.18);
  padding: 12px; position: relative; overflow: hidden;
}
.canvas__grid{
  display:grid;
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
  grid-auto-rows: 8px;
  grid-auto-flow: dense;
  gap: var(--gap);
}
.canvas__tile{
  position:relative; overflow:hidden; border-radius:12px;
  background: var(--tile-warm);
  box-shadow: var(--shadow-sm);
}
.canvas__tile img{ width:100%; height:auto; display:block; object-fit:cover; }
.canvas__empty{
  position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
  color: var(--warm-text); opacity:.95; font-size:14px; text-align:center; padding:10px;
}
.canvas--has-items .canvas__empty{ display:none; }

.grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:18px; container-type:inline-size; }
.card{
  position:relative; border-radius:18px; overflow:hidden; cursor:grab;
  background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.08);
  box-shadow:var(--shadow-md); transition:transform .2s, box-shadow .2s; min-height:200px;
}
.card:active{ cursor:grabbing } .card:hover{ transform:translateY(-3px); box-shadow:var(--shadow-lg) }
.card__img{ width:100%; height:150px; object-fit:cover; display:block; background:#0e1417 }
.card__body{ padding:10px 12px; display:flex; flex-direction:column; gap:6px }
.card__title{ margin:0; font-weight:800; color:rgb(var(--mint)); font-size:15px; line-height:1.3 }
.card__note{ margin:0; color:#c9e9df; font-size:13px; line-height:1.45; white-space:pre-wrap }
.badge{ font-size:12px; color:#9fdaca }
.card__tools{ position:absolute; inset:auto 8px 8px auto; display:flex; gap:6px }
.tool{ border:1px solid rgba(255,255,255,.16); background:rgba(0,0,0,.35); color:#dffdf3; border-radius:10px; padding:6px 8px; font-size:14px; cursor:pointer }
.tool:hover{ filter:brightness(1.1) }

.modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:50;
  background: radial-gradient(60% 60% at 20% 10%, rgba(var(--mint)/.10), transparent 60%),
              radial-gradient(70% 70% at 80% 90%, rgba(var(--mint)/.08), transparent 65%),
              rgba(0,0,0,.58);
  padding: clamp(10px,3vw,24px);
}
.modal.show{ display:flex }
.dialog{ width:min(620px,96vw); border-radius:var(--r-xl);
  background:linear-gradient(180deg, rgba(var(--glass)) 0%, rgba(var(--glass)) 100%);
  backdrop-filter:blur(20px) saturate(130%);
  -webkit-backdrop-filter:blur(20px) saturate(130%);
  border:1px solid rgba(255,255,255,.12); box-shadow:var(--shadow-lg); padding:16px 16px 14px }
.dialog h2{ margin:0 0 10px; color:rgb(var(--mint)) }
.form{ display:grid; gap:10px } .row{ display:grid; grid-template-columns:1fr 1fr; gap:10px }
label{ font-size:13px; color:#dffdf3; opacity:.9 }
input[type="text"], textarea, select{
  width:100%; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.35); color:#eafaf5; outline:none;
}
textarea{ min-height:90px; resize:vertical }
/* A√ßƒ±k√ßa PNG/JPEG kabul et + bilgi */
input[type="file"]{ color:#cfeee6 }
.tip{ font-size:12px; color:#a9dcd0; margin-top:4px }

.viewer{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:40;
  background:rgba(0,0,0,.66); padding:clamp(10px,3vw,24px) }
.viewer.show{ display:flex }
.viewer__box{ position:relative; background:linear-gradient(180deg, rgba(var(--glass)) 0%, rgba(var(--glass)) 100%);
  border:1px solid rgba(255,255,255,.1); border-radius:18px; box-shadow:var(--shadow-lg);
  max-width:96vw; max-height:92vh; padding:10px; display:flex; align-items:center; justify-content:center; }
.viewer__img{ max-width:min(92vw,1200px); max-height:88vh; object-fit:contain; border-radius:12px; background:#0e1417 }
.viewer__close{ position:absolute; right:8px; top:8px; border:1px solid rgba(255,255,255,.2);
  background:rgba(0,0,0,.35); color:#dffdf3; border-radius:10px; padding:6px 10px; cursor:pointer }

footer{ text-align:center; margin-top:6px }
a.back{ color:rgb(var(--mint)); text-decoration:none; font-weight:600; border:1px solid rgba(255,255,255,.12);
  border-radius:999px; padding:10px 18px; background:rgba(255,255,255,.04); box-shadow:var(--shadow-md) }
a.back:hover{ filter:brightness(1.1) }

@container (min-width: 418px) and (max-width: 635px){ .grid > .card:nth-child(n + 3){ margin-top: 10px; } }
@container (min-width: 636px){ .grid > .card:nth-child(n + 4){ margin-top: 12px; } }
</style>
</head>
<body>
<main class="wrap">
  <header class="head">
    <h1>Vision Board</h1>
    <p class="sub">hayaller, hedefler, istekler</p>
  </header>

  <section class="canvas" id="boardCanvas">
    <div class="canvas__grid" id="canvasGrid"></div>
    <div class="canvas__empty" id="canvasEmpty">G√∂rseller burada kolaj olacak ‚Äî kart ekle a≈ükƒ±m üíö</div>
  </section>

  <div class="toolbar">
    <button class="btn primary" id="addBtn">+ Kart Ekle</button>
    <button class="btn" id="exportBtn">Dƒ±≈üa Aktar</button>
    <button class="btn" id="importBtn">ƒ∞√ße Al</button>
    <button class="btn" id="downloadBtn">Vision board'ƒ± indir</button>
    <button class="btn" id="clearBtn" title="Panoyu sƒ±fƒ±rla (yalnƒ±zca bu cihazda)">Temizle</button>
  </div>

  <section id="grid" class="grid" aria-live="polite"></section>

  <footer><a class="back" href="index.html">‚Üê Ana men√º</a></footer>
</main>

<div class="modal" id="modal" aria-hidden="true" role="dialog">
  <div class="dialog">
    <h2 id="formTitle">Kart Ekle</h2>
    <form class="form" id="form">
      <div class="row">
        <div>
          <label>Ba≈ülƒ±k</label>
          <input type="text" id="fTitle" placeholder="√ñrn. Tatil" required />
        </div>
        <div>
          <label>Kategori</label>
          <select id="fCat">
            <option>Biz</option><option>Seyahat</option><option>Saƒülƒ±k & Spor</option>
            <option>Kariyer</option><option>Ev</option><option>√ñƒürenme</option><option>Ruh Hali</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>G√∂rsel URL</label>
          <input type="text" id="fImgUrl" placeholder="https://‚Ä¶ veya bo≈ü bƒ±rak" />
        </div>
        <div>
          <label>Dosya Y√ºkle (PNG/JPEG)</label>
          <input type="file" id="fImgFile" accept=".png,.jpg,.jpeg,image/png,image/jpeg" />
        </div>
      </div>

      <div>
        <label>Not</label>
        <textarea id="fNote" placeholder="Kƒ±sa bir a√ßƒ±klama"></textarea>
      </div>

      <div class="actions">
        <button type="button" class="btn cancel" id="cancelBtn">Vazge√ß</button>
        <button type="submit" class="btn primary" id="saveBtn">Kaydet</button>
      </div>
    </form>
  </div>
</div>

<!-- Viewer -->
<div class="viewer" id="viewer" aria-hidden="true">
  <div class="viewer__box" id="viewerBox">
    <img id="viewImg" class="viewer__img" alt="">
    <button class="viewer__close" id="viewerClose" aria-label="Kapat">‚úï</button>
  </div>
</div>

<script>
const STORE_KEY = "vision.board.v1";
let items = load() || [];
let editingId = null;

const grid = document.getElementById("grid");
const modal = document.getElementById("modal");
const form = document.getElementById("form");
const fTitle = document.getElementById("fTitle");
const fCat = document.getElementById("fCat");
const fImgUrl = document.getElementById("fImgUrl");
const fImgFile = document.getElementById("fImgFile");
const fNote = document.getElementById("fNote");
const formTitle = document.getElementById("formTitle");

const canvas = document.getElementById("boardCanvas");
const canvasGrid = document.getElementById("canvasGrid");
let ro = null;

function load(){
  try{ return JSON.parse(localStorage.getItem(STORE_KEY) || "null"); }
  catch(e){ console.warn("load err:", e); return null; }
}
function save(){
  try{
    localStorage.setItem(STORE_KEY, JSON.stringify(items));
    return true;
  }catch(e){
    console.warn("save err:", e);
    return false;
  }
}

function uid(){ return Math.random().toString(36).slice(2,10); }
function escapeHtml(s){ return (s||"").replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
function isSupportedFile(file){
  const ok = ["image/png","image/jpeg","image/jpg"];
  return ok.includes((file.type||"").toLowerCase());
}

function askConfirm(msg){
  try { return typeof confirm === "function" ? confirm(msg) : true; }
  catch { return true; }
}

function trySaveOrSalvage(){
  if (save()) return true;
  try { localStorage.removeItem(STORE_KEY); } catch {}
  return save();
}

function approxBytes(str){ return (str?.length || 0) * 2; }

async function downscaleToJpeg(src, maxDim=1280, quality=0.85){
  return new Promise((resolve)=>{
    const img = new Image();
    img.onload = ()=>{
      let w = img.width, h = img.height;
      const scale = Math.min(1, maxDim/Math.max(w,h));
      w = Math.max(1, Math.round(w*scale));
      h = Math.max(1, Math.round(h*scale));
      const c = document.createElement("canvas"); c.width=w; c.height=h;
      const ctx = c.getContext("2d");
      ctx.drawImage(img, 0, 0, w, h);
      try{
        resolve(c.toDataURL("image/jpeg", quality));
      }catch(e){
        console.warn("toDataURL fail, fallback src", e);
        resolve(src);
      }
    };
    img.onerror = ()=>resolve(src);
    img.src = src;
  });
}

async function compressForStorage(dataURL, targetBytes = 2_300_000){
  let out = dataURL, dim = 1280, q = 0.82;
  for (let i=0; i<4 && approxBytes(out) > targetBytes; i++){
    dim = Math.max(640, Math.round(dim * 0.85));
    q   = Math.max(0.6, q - 0.08);
    out = await downscaleToJpeg(out, dim, q);
  }
  return out;
}

async function fileToDataURL(file){
  const dataURL = await new Promise((res,rej)=>{
    const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file);
  });
  const first = await downscaleToJpeg(dataURL, 1280, 0.85);
  return await compressForStorage(first, 2_300_000); 
}

function render(){
  grid.innerHTML = items.map(it => cardHTML(it)).join("");
  bindCardEvents();
  renderCanvas();
}
function cardHTML(it){
  const safeTitle = escapeHtml(it.title || "");
  const safeNote = escapeHtml(it.note || "");
  return `
  <article class="card" draggable="true" data-id="${it.id}">
    <img class="card__img" src="${it.img || ""}" alt="${safeTitle}" onerror="this.style.opacity=0.3">
    <div class="card__body" onclick="openViewer('${encodeURIComponent(it.img||"")}')">
      <div class="badge">${it.cat||""}</div>
      <h3 class="card__title">${safeTitle}</h3>
      <p class="card__note">${safeNote}</p>
    </div>
    <div class="card__tools">
      <button class="tool" data-act="edit" title="D√ºzenle">‚úé</button>
      <button class="tool" data-act="del" title="Sil">üóë</button>
    </div>
  </article>`;
}

function renderCanvas(){
  const imgs = items.map(it => it.img).filter(Boolean);
  const empty = document.querySelector(".canvas__empty");
  if(imgs.length === 0){
    canvas.classList.remove("canvas--has-items");
    canvasGrid.innerHTML = "";
    empty && (empty.style.display = "flex");
    return;
  }
  canvas.classList.add("canvas--has-items");
  empty && (empty.style.display = "none");

  let html = "";
  items.forEach((it, i) => {
    if(!it.img) return;
    if(typeof it.wSpan === "undefined"){
      const r = (i * 9301 + 49297) % 233280 / 233280;
      it.wSpan = r < 0.22 ? 2 : 1;
    }
    html += `<div class="canvas__tile" style="grid-column: span ${it.wSpan}"><img src="${it.img}" alt=""></div>`;
  });
  canvasGrid.innerHTML = html;

  canvasGrid.querySelectorAll(".canvas__tile img").forEach(img=>{
    if(img.complete){ resizeMasonryItem(img.closest(".canvas__tile")); }
    else img.addEventListener("load", ()=>resizeMasonryItem(img.closest(".canvas__tile")));
  });

  if(!ro){
    ro = new ResizeObserver(()=>resizeAllMasonry());
    ro.observe(canvasGrid);
  }
}
function resizeMasonryItem(item){
  const rowH = parseFloat(getComputedStyle(canvasGrid).getPropertyValue("grid-auto-rows"));
  const gap  = parseFloat(getComputedStyle(canvasGrid).getPropertyValue("gap"));
  const img  = item.querySelector("img"); if(!img) return;
  const h = img.getBoundingClientRect().height;
  const span = Math.max(1, Math.ceil((h + gap) / (rowH + gap)));
  item.style.gridRowEnd = "span " + span;
}
function resizeAllMasonry(){
  canvasGrid.querySelectorAll(".canvas__tile").forEach(resizeMasonryItem);
}

/* =============== MODAL =============== */
function openModal(edit=null){
  modal.classList.add("show");
  document.body.style.overflow = "hidden";
  if(edit){
    editingId = edit.id;
    formTitle.textContent = "Kartƒ± D√ºzenle";
    fTitle.value = edit.title || "";
    fCat.value = edit.cat || "Biz";
    fImgUrl.value = ""; fImgFile.value = "";
    fNote.value = edit.note || "";
  }else{
    editingId = null; formTitle.textContent = "Kart Ekle"; form.reset();
  }
  fTitle.focus();
}
function closeModal(){
  modal.classList.remove("show");
  document.body.style.overflow = "";
  form.reset(); editingId = null;
}

document.getElementById("addBtn").addEventListener("click",()=>openModal());
document.getElementById("cancelBtn").addEventListener("click",closeModal);
modal.addEventListener("click", (e)=>{ if(e.target === modal) closeModal(); });

form.addEventListener("submit", async (e)=>{
  e.preventDefault();
  const title = fTitle.value.trim(); if(!title) return;
  const cat   = fCat.value.trim();
  const note  = fNote.value.trim();

  let img = "";
  if(fImgFile.files && fImgFile.files[0]){
    const file = fImgFile.files[0];
    if(!isSupportedFile(file)){
      alert("Bu dosya t√ºr√º desteklenmiyor. L√ºtfen PNG veya JPEG se√ßin.");
      return;
    }
    try{
      img = await fileToDataURL(file);
    }catch(err){
      console.warn("file read fail:", err);
      alert("G√∂rsel okunamadƒ±. Farklƒ± bir PNG/JPEG deneyin.");
      return;
    }
  }
  else if(fImgUrl.value.trim()){
    img = fImgUrl.value.trim();
  }

  if(!img){
    alert("Bir g√∂rsel se√ßin ya da URL girin.");
    return;
  }

  const snapshot = JSON.stringify(items); 
  if(editingId){
    const idx = items.findIndex(x=>x.id===editingId);
    if(idx>-1){ items[idx] = {...items[idx], title, cat, note, img: img || items[idx].img }; }
  }else{
    items.push({ id:uid(), title, cat, note, img, t:Date.now() });
  }

  if(!trySaveOrSalvage()){
    try{ items = JSON.parse(snapshot); }catch(_){}
    alert("Kaydetme ba≈üarƒ±sƒ±z (depolama limiti veya tarayƒ±cƒ± engeli). 'Dƒ±≈üa Aktar' ile yedekleyip 'Temizle' deneyin.");
    return;
  }

  render(); closeModal();
});

function bindCardEvents(){
  // edit/sil
  grid.querySelectorAll(".card .tool").forEach(btn=>{
    btn.addEventListener("click", (e)=>{
      e.stopPropagation();
      const act = btn.dataset.act;
      const id = btn.closest(".card").dataset.id;
      const it = items.find(x=>x.id===id); if(!it) return;
      if(act==="edit"){ openModal(it); }
      if(act==="del"){
        if(askConfirm("Bu kart silinsin mi?")){
          const snapshot = JSON.stringify(items);
          items = items.filter(x=>x.id!==id);
          if(!trySaveOrSalvage()){
            try{ items = JSON.parse(snapshot); }catch(_){}
            alert("Silerken kaydetme ba≈üarƒ±sƒ±z oldu (depolama kƒ±sƒ±tƒ±).");
          }
          render();
        }
      }
    });
  });

  grid.querySelectorAll(".card").forEach(card=>{
    card.addEventListener("dragstart", (e)=>{
      e.dataTransfer.setData("text/plain", card.dataset.id);
      e.dataTransfer.effectAllowed = "move";
    });
    card.addEventListener("dragover", (e)=>{ e.preventDefault(); e.dataTransfer.dropEffect="move"; });
    card.addEventListener("drop", (e)=>{
      e.preventDefault();
      const fromId = e.dataTransfer.getData("text/plain");
      const toCard = card;
      if(fromId && fromId !== toCard.dataset.id){
        const fromEl = grid.querySelector(`[data-id="${fromId}"]`);
        grid.insertBefore(fromEl, toCard);
        syncOrderFromDOM();
      }
    });
  });
}
function syncOrderFromDOM(){
  const order = [...grid.querySelectorAll(".card")].map(el=>el.dataset.id);
  items.sort((a,b)=> order.indexOf(a.id) - order.indexOf(b.id) );
  if(!trySaveOrSalvage()){
    alert("Sƒ±ralama kaydedilemedi (depolama kƒ±sƒ±tƒ±).");
  }
  renderCanvas();
}

const viewer = document.getElementById("viewer");
const viewerBox = document.getElementById("viewerBox");
const viewImg = document.getElementById("viewImg");
document.getElementById("viewerClose").addEventListener("click", closeViewer);
viewer.addEventListener("click", closeViewer);
viewerBox.addEventListener("click", e=>e.stopPropagation());
document.addEventListener("keydown", e=>{ if(e.key==="Escape") closeViewer(); });

function openViewer(srcEncoded){
  const src = decodeURIComponent(srcEncoded || "");
  if(!src) return;
  viewImg.src = src;
  viewer.classList.add("show");
  document.body.style.overflow = "hidden";
}
function closeViewer(){
  viewer.classList.remove("show");
  document.body.style.overflow = "";
}

document.getElementById("exportBtn").addEventListener("click", ()=>{
  const blob = new Blob([JSON.stringify(items,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = Object.assign(document.createElement("a"), { href:url, download:"vision-board.json" });
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});
document.getElementById("importBtn").addEventListener("click", ()=>{
  const inp = Object.assign(document.createElement("input"), {type:"file", accept:"application/json"});
  inp.addEventListener("change", async ()=>{
    const file = inp.files?.[0]; if(!file) return;
    const text = await file.text();
    try{
      const data = JSON.parse(text);
      if(Array.isArray(data)){ items = data; }
      else if(Array.isArray(data.items)){ items = data.items; }
      else return alert("Dosya formatƒ± beklenen gibi deƒüil.");
      if(!trySaveOrSalvage()){ alert("Kaydedilemedi (depolama kƒ±sƒ±tƒ±)."); }
      render();
    }catch(e){ alert("JSON okunamadƒ±."); }
  });
  inp.click();
});
document.getElementById("clearBtn").addEventListener("click", ()=>{
  if (!askConfirm("Bu cihazdaki vision board verileri silinsin mi?")) return;
  items = [];
  try{ localStorage.removeItem(STORE_KEY); }catch(_){}
  render();
});
document.getElementById("downloadBtn").addEventListener("click", async ()=>{
  const target = document.getElementById("boardCanvas");
  const canvas = await html2canvas(target, {useCORS: true, allowTaint: false, backgroundColor: null, scale: 2});
  const link = document.createElement("a");
  link.download = "vision-board.png";
  link.href = canvas.toDataURL("image/png");
  link.click();
});

render();
</script>
</body>
</html>