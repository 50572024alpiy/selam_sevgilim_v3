<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Photobooth</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#050814;
      --bg1:#070B1C;
      --card: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.66);
      --muted2: rgba(255,255,255,.50);
      --shadow: 0 18px 55px rgba(0,0,0,.48);
      --r20: 20px;
      --r24: 24px;

      --iceA: #7dd3fc;
      --iceB: #a5b4fc;
      --iceC: #e0f2fe;
      --danger: #fb7185;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }

    html{
      background:
        radial-gradient(1000px 700px at 20% -10%, rgba(125,211,252,.18), transparent 58%),
        radial-gradient(900px 700px at 110% 10%, rgba(165,180,252,.16), transparent 60%),
        radial-gradient(900px 700px at 50% 120%, rgba(224,242,254,.10), transparent 62%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      background-repeat: no-repeat;
      background-size: cover;
      background-color: var(--bg1);
    }
    body{
      margin:0;
      color:var(--text);
      font-family: Manrope, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: transparent;
      overflow-x:hidden;
    }

    .snow-lite{
      position: fixed;
      inset: -120px;
      pointer-events:none;
      z-index: 0;
      opacity: .14;
      will-change: transform;
      transform: translate3d(0,0,0);
      background-image:
        radial-gradient(circle, rgba(255,255,255,.85) 0 1px, transparent 2px),
        radial-gradient(circle, rgba(255,255,255,.55) 0 1px, transparent 2px);
      background-size: 320px 320px, 520px 520px;
      background-position: 0 0, 160px 240px;
      animation: snowLiteMove 22s linear infinite;
    }
    @keyframes snowLiteMove{
      from { transform: translate3d(-8px, -180px, 0); }
      to   { transform: translate3d( 14px,  780px, 0); }
    }
    @media (prefers-reduced-motion: reduce){
      .snow-lite{ animation: none !important; display:none; }
    }

    .wrap{
      position: relative;
      z-index: 2;
      max-width: 980px;
      margin: 0 auto;
      padding: 22px 16px 28px;
    }

    header{
      display:flex;
      gap:14px;
      align-items:center;
      justify-content:space-between;
      margin-bottom: 14px;
    }

    .brand{ display:flex; flex-direction:column; gap:4px; }
    .brand h1{ font-size: 18px; margin:0; letter-spacing:.2px; font-weight: 900; }
    .brand p{ margin:0; color:var(--muted); font-size: 13px; line-height: 1.25; }

    .pill{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 10px 30px rgba(0,0,0,.18);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      font-size: 12.5px;
      color: var(--muted);
      user-select:none;
    }
    .dot{
      width:10px;height:10px;border-radius:50%;
      background: rgba(255,255,255,.25);
      box-shadow: 0 0 0 4px rgba(255,255,255,.06);
    }
    .dot.on{
      background: #34d399;
      box-shadow: 0 0 0 4px rgba(52,211,153,.14);
    }

    .card{
      border-radius: var(--r24);
      background: var(--card);
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      overflow:hidden;
      position:relative;
      margin-bottom: 14px;
    }
    .card::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(900px 320px at 0% 0%, rgba(125,211,252,.16), transparent 58%),
        radial-gradient(700px 300px at 100% 100%, rgba(165,180,252,.14), transparent 60%);
      opacity:.85;
      pointer-events:none;
      filter: blur(14px);
    }
    .card > *{ position:relative; z-index:1; }

    .sectionHead{
      padding: 14px 14px 0;
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
    }
    .sectionHead h2{
      margin:0;
      font-size: 12.5px;
      color: rgba(255,255,255,.68);
      font-weight: 900;
      letter-spacing: .7px;
      text-transform: uppercase;
    }
    .sectionHead .hint{
      margin:0;
      font-size:12px;
      color: var(--muted2);
      text-align:right;
    }

    .cameraBody{ padding: 14px; padding-top: 10px; }

    .viewport{
      border-radius: var(--r20);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.35);
      position:relative;
      aspect-ratio: 16 / 10;
      box-shadow: 0 14px 30px rgba(0,0,0,.30);
    }
    video{
      width:100%;
      height:100%;
      object-fit: cover;
      display:block;
      transform-origin:center;
    }
    .frameGlow{
      position:absolute; inset:0;
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,.10),
        inset 0 0 60px rgba(125,211,252,.10),
        inset 0 0 120px rgba(165,180,252,.08);
      pointer-events:none;
    }

    .countdown{
      position:absolute;
      inset:0;
      display:none;
      place-items:center;
      background: rgba(0,0,0,.42);
      backdrop-filter: blur(7px);
      -webkit-backdrop-filter: blur(7px);
      pointer-events:none;
    }
    .countdown .num{
      font-size: 78px;
      font-weight: 900;
      letter-spacing: -1px;
      text-shadow: 0 14px 45px rgba(0,0,0,.55);
      background: linear-gradient(90deg, var(--iceC), var(--iceA));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    .controls{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top: 12px;
    }
    .btn{
      appearance:none;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      color: var(--text);
      border-radius: 14px;
      padding: 10px 12px;
      font-weight: 900;
      font-size: 13px;
      letter-spacing: .2px;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease, border-color .12s ease, opacity .12s ease;
      user-select:none;
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,.22); background: rgba(255,255,255,.08); }
    .btn:active{ transform: translateY(0px) scale(.99); }
    .btn:disabled{ opacity:.45; cursor:not-allowed; transform:none; }

    .btn.primary{
      border: 1px solid rgba(125,211,252,.32);
      background:
        radial-gradient(700px 260px at 20% 10%, rgba(125,211,252,.20), transparent 58%),
        radial-gradient(700px 260px at 90% 120%, rgba(165,180,252,.18), transparent 60%),
        rgba(255,255,255,.05);
    }
    .btn.danger{
      border-color: rgba(251,113,133,.32);
      background: rgba(251,113,133,.10);
    }

    .btn.back{
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      border-radius: 999px;
      padding: 10px 12px;
      white-space: nowrap;
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top: 10px;
    }
    .field{
      flex: 1 1 220px;
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
    }
    .field label{
      font-size:12px;
      color: rgba(255,255,255,.64);
      font-weight: 900;
      white-space:nowrap;
    }
    .field select{
      width:100%;
      background: transparent;
      border:none;
      outline:none;
      color: var(--text);
      font-size: 13px;
      font-weight: 700;
    }
    .field select option{ background:#070b1c; }

    .gallery{ padding: 12px 14px 14px; }
    .actionBar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      padding: 12px 14px 0;
    }
    .selectedInfo{
      display:flex;
      gap:10px;
      align-items:center;
      color: rgba(255,255,255,.78);
      font-size: 13px;
      font-weight: 900;
      min-width: 220px;
    }
    .badge{
      font-size: 11px;
      font-weight: 950;
      padding: 6px 8px;
      border-radius: 999px;
      background: rgba(0,0,0,.30);
      border: 1px solid rgba(255,255,255,.12);
      color: rgba(255,255,255,.88);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .thumbs{
      margin-top: 12px;
      display:flex;
      gap:10px;
      overflow:auto;
      padding-bottom: 4px;
    }
    .thumb{
      flex: 0 0 auto;
      width: 118px;
      aspect-ratio: 10/12;
      border-radius: 16px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.32);
      cursor:pointer;
      position:relative;
      box-shadow: 0 12px 24px rgba(0,0,0,.25);
      transition: transform .12s ease, border-color .12s ease, box-shadow .12s ease;
    }
    .thumb:hover{
      transform: translateY(-2px);
      border-color: rgba(255,255,255,.22);
    }
    .thumb.selected{
      border-color: rgba(125,211,252,.55);
      box-shadow: 0 18px 44px rgba(125,211,252,.10), 0 12px 24px rgba(0,0,0,.25);
    }
    .thumb img{ width:100%; height:100%; object-fit: cover; display:block; }
    .thumb .tag{
      position:absolute;
      left:8px; bottom:8px;
      font-size: 11px;
      font-weight: 950;
      padding: 6px 8px;
      border-radius: 999px;
      background: rgba(0,0,0,.45);
      border: 1px solid rgba(255,255,255,.12);
      color: rgba(255,255,255,.88);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .foot{
      margin-top: 12px;
      color: rgba(255,255,255,.50);
      font-size: 12px;
      line-height: 1.35;
      padding: 0 14px 14px;
    }

    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 11px;
      border: 1px solid rgba(255,255,255,.12);
      padding: 2px 6px;
      border-radius: 8px;
      background: rgba(0,0,0,.20);
      color: rgba(255,255,255,.78);
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.60);
      border: 1px solid rgba(255,255,255,.14);
      color: rgba(255,255,255,.90);
      padding: 10px 12px;
      border-radius: 14px;
      box-shadow: 0 20px 60px rgba(0,0,0,.55);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      font-size: 13px;
      display:none;
      max-width: min(680px, calc(100vw - 24px));
      z-index: 5;
    }
  </style>
</head>

<body>
  <div class="snow-lite" aria-hidden="true"></div>

  <div class="wrap">
    <header>
      <div class="brand">
        <h1>Photobooth for Love ü§ç</h1>
      </div>

      <div style="display:flex; gap:10px; align-items:center;">
        <a class="btn back" href="index.html" aria-label="Ana sayfaya d√∂n">‚Üê Ana sayfaya d√∂n</a>

        <div class="pill" title="Kamera durumu">
          <span class="dot" id="statusDot"></span>
          <span id="statusText">Kamera kapalƒ±</span>
        </div>
      </div>
    </header>

    <section class="card">
      <div class="sectionHead">
        <h2>Kamera</h2>
        <p class="hint">Kƒ±sayol: <span class="kbd">Space</span> √ßekim</p>
      </div>

      <div class="cameraBody">
        <div class="viewport">
          <video id="video" autoplay playsinline muted></video>
          <div class="frameGlow"></div>

          <div class="countdown" id="countdown">
            <div class="num" id="countNum">3</div>
          </div>
        </div>

        <div class="controls">
          <button class="btn primary" id="btnStart">Kamerayƒ± A√ß</button>
          <button class="btn" id="btnSnap" disabled>√áek</button>
          <button class="btn" id="btnStrip" disabled>4‚Äôl√º ≈ûerit</button>
          <button class="btn" id="btnMirror" disabled>Ayna: Kapalƒ±</button>
          <button class="btn danger" id="btnStop" disabled>Durdur</button>
        </div>

        <div class="row">
          <div class="field">
            <label for="facing">Kamera</label>
            <select id="facing" disabled>
              <option value="user">√ñn (selfie)</option>
              <option value="environment">Arka</option>
            </select>
          </div>

          <div class="field">
            <label for="timer">Zamanlayƒ±cƒ±</label>
            <select id="timer">
              <option value="0">0 sn</option>
              <option value="2">2 sn</option>
              <option value="3" selected>3 sn</option>
              <option value="5">5 sn</option>
            </select>
          </div>
        </div>
      </div>
    </section>

    <!-- GALLERY -->
    <section class="card">
      <div class="sectionHead">
        <h2>Galeri</h2>
      </div>

      <div class="actionBar">
        <div class="selectedInfo">
          <span class="badge" id="selBadge">Se√ßili: Yok</span>
          <span id="selMeta" style="color: rgba(255,255,255,.58); font-weight:750;">‚Äî</span>
        </div>

        <div class="controls" style="margin:0;">
          <button class="btn primary" id="btnDownloadPng" disabled>Se√ßiliyi PNG indir</button>
          <button class="btn danger" id="btnDelete" disabled>Se√ßiliyi sil</button>
          <button class="btn danger" id="btnClearAll">T√ºm√ºn√º temizle</button>
        </div>
      </div>

      <div class="gallery">
        <div class="thumbs" id="thumbs"></div>
      </div>

    </section>
  </div>

  <div class="toast" id="toast"></div>

  <canvas id="exportCanvas" style="position:fixed; left:-99999px; top:-99999px;"></canvas>

  <script>
    const els = {
      video: document.getElementById('video'),
      exportCanvas: document.getElementById('exportCanvas'),

      btnStart: document.getElementById('btnStart'),
      btnSnap: document.getElementById('btnSnap'),
      btnStrip: document.getElementById('btnStrip'),
      btnMirror: document.getElementById('btnMirror'),
      btnStop: document.getElementById('btnStop'),

      facing: document.getElementById('facing'),
      timer: document.getElementById('timer'),

      thumbs: document.getElementById('thumbs'),

      statusDot: document.getElementById('statusDot'),
      statusText: document.getElementById('statusText'),

      countdown: document.getElementById('countdown'),
      countNum: document.getElementById('countNum'),

      btnDownloadPng: document.getElementById('btnDownloadPng'),
      btnDelete: document.getElementById('btnDelete'),
      btnClearAll: document.getElementById('btnClearAll'),

      selBadge: document.getElementById('selBadge'),
      selMeta: document.getElementById('selMeta'),

      toast: document.getElementById('toast'),
    };

    const ctx = els.exportCanvas.getContext('2d', { alpha: false });

    let stream = null;
    let mirrored = false;

    let selectedId = null;
    const items = new Map(); 

    function toast(msg){
      els.toast.textContent = msg;
      els.toast.style.display = 'block';
      clearTimeout(toast._t);
      toast._t = setTimeout(() => els.toast.style.display = 'none', 2300);
    }

    function setStatus(on, text){
      els.statusDot.classList.toggle('on', !!on);
      els.statusText.textContent = text;
    }

    function enableCameraUI(enabled){
      els.btnSnap.disabled = !enabled;
      els.btnStrip.disabled = !enabled;
      els.btnMirror.disabled = !enabled;
      els.btnStop.disabled = !enabled;
      els.facing.disabled = !enabled;
    }

    function updateSelectionUI(){
      const hasSel = !!(selectedId && items.has(selectedId));
      els.btnDownloadPng.disabled = !hasSel;
      els.btnDelete.disabled = !hasSel;

      if (!hasSel){
        els.selBadge.textContent = 'Se√ßili: Yok';
        els.selMeta.textContent = '‚Äî';
        return;
      }

      const it = items.get(selectedId);
      els.selBadge.textContent = `Se√ßili: ${it.label}`;
      els.selMeta.textContent = it.createdAt;
    }

    function applyMirror(){
      els.video.style.transform = mirrored ? 'scaleX(-1)' : 'none';
      els.btnMirror.textContent = mirrored ? 'Ayna: A√ßƒ±k' : 'Ayna: Kapalƒ±';
    }

    function pad2(n){ return String(n).padStart(2,'0'); }
    function stamp(){
      const d = new Date();
      return `${d.getFullYear()}${pad2(d.getMonth()+1)}${pad2(d.getDate())}-${pad2(d.getHours())}${pad2(d.getMinutes())}${pad2(d.getSeconds())}`;
    }
    function prettyNow(){ return new Date().toLocaleString('tr-TR'); }
    function uid(){ return 'id-' + Math.random().toString(16).slice(2) + '-' + Date.now().toString(16); }

    async function startCamera(){
      if (stream) stopCamera();

      const facingMode = els.facing.value;
      const constraints = {
        audio: false,
        video: {
          facingMode,
          width:  { ideal: 3840 },
          height: { ideal: 2160 }
        }
      };

      try{
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        els.video.srcObject = stream;
        await els.video.play();

        setStatus(true, 'Kamera a√ßƒ±k');
        enableCameraUI(true);
        els.btnStart.disabled = true;

        applyMirror();
        toast('Kamera hazƒ±r.');
      }catch(err){
        console.error(err);
        setStatus(false, 'Kamera a√ßƒ±lamadƒ±');
        toast('Kamera izni gerekli (HTTPS). Tarayƒ±cƒ± izinlerini kontrol et.');
        els.btnStart.disabled = false;
        enableCameraUI(false);
      }
    }

    function stopCamera(){
      try{
        if (stream){
          stream.getTracks().forEach(t => t.stop());
          stream = null;
        }
        els.video.srcObject = null;
      }catch(e){}

      setStatus(false, 'Kamera kapalƒ±');
      els.btnStart.disabled = false;
      enableCameraUI(false);
      toast('Kamera durduruldu.');
    }

    function ensureCanvasSize(w, h){
      const dpr = window.devicePixelRatio || 1;
      els.exportCanvas.width  = Math.round(w * dpr);
      els.exportCanvas.height = Math.round(h * dpr);
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }

    function capturePNGDataURL(){
      const vw = els.video.videoWidth;
      const vh = els.video.videoHeight;
      if (!vw || !vh) return null;

      ensureCanvasSize(vw, vh);
      ctx.save();
      ctx.clearRect(0,0,vw,vh);

      if (mirrored){
        ctx.translate(vw, 0);
        ctx.scale(-1, 1);
      }
      ctx.drawImage(els.video, 0, 0, vw, vh);
      ctx.restore();

      const g = ctx.createRadialGradient(vw*0.5, vh*0.45, Math.min(vw,vh)*0.22, vw*0.5, vh*0.5, Math.max(vw,vh)*0.80);
      g.addColorStop(0, 'rgba(0,0,0,0)');
      g.addColorStop(1, 'rgba(0,0,0,0.18)');
      ctx.fillStyle = g;
      ctx.fillRect(0,0,vw,vh);

      return els.exportCanvas.toDataURL('image/png');
    }

    function downloadDataURL(dataURL, filename){
      const a = document.createElement('a');
      a.href = dataURL;
      a.download = filename;

      if (typeof a.download === 'undefined'){
        window.open(dataURL, '_blank', 'noopener,noreferrer');
        return;
      }
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    function clearThumbSelection(){
      els.thumbs.querySelectorAll('.thumb.selected').forEach(t => t.classList.remove('selected'));
    }

    function selectItem(id){
      if (!items.has(id)){
        selectedId = null;
        updateSelectionUI();
        return;
      }
      selectedId = id;

      clearThumbSelection();
      const el = els.thumbs.querySelector(`[data-id="${CSS.escape(id)}"]`);
      if (el) el.classList.add('selected');

      updateSelectionUI();
    }

    function addThumb(dataURL, label){
      const id = uid();
      items.set(id, { dataURL, label, createdAt: prettyNow() });

      const wrap = document.createElement('button');
      wrap.className = 'thumb';
      wrap.type = 'button';
      wrap.dataset.id = id;

      const img = document.createElement('img');
      img.src = dataURL;
      img.alt = label;

      const tag = document.createElement('div');
      tag.className = 'tag';
      tag.textContent = label;

      wrap.appendChild(img);
      wrap.appendChild(tag);

      wrap.addEventListener('click', () => {
        selectItem(id);
        toast('Se√ßildi.');
      });

      els.thumbs.prepend(wrap);
      selectItem(id);
    }

    async function showCountdown(seconds){
      if (seconds <= 0) return;
      els.countdown.style.display = 'grid';
      for (let s = seconds; s >= 1; s--){
        els.countNum.textContent = s;
        await new Promise(r => setTimeout(r, 1000));
      }
      els.countdown.style.display = 'none';
    }

    async function snapSingle(){
      const t = parseInt(els.timer.value, 10) || 0;
      await showCountdown(t);

      const png = capturePNGDataURL();
      if (!png){
        toast('Video hazƒ±r deƒüil. 1-2 sn bekleyip tekrar dene.');
        return;
      }
      addThumb(png, 'Foto');
      toast('√áekildi.');
    }

    function roundRect(c, x, y, w, h, r){
      const rr = Math.min(r, w/2, h/2);
      c.beginPath();
      c.moveTo(x+rr, y);
      c.arcTo(x+w, y, x+w, y+h, rr);
      c.arcTo(x+w, y+h, x, y+h, rr);
      c.arcTo(x, y+h, x, y, rr);
      c.arcTo(x, y, x+w, y, rr);
      c.closePath();
    }

    async function snapStrip(){
      const t = parseInt(els.timer.value, 10) || 0;
      const shots = [];

      for (let i=0; i<4; i++){
        await showCountdown(t);
        const png = capturePNGDataURL();
        if (!png){
          toast('Video hazƒ±r deƒüil. 1-2 sn bekleyip tekrar dene.');
          return;
        }
        shots.push(png);
        toast(`${i+1}/4 √ßekildi`);
        await new Promise(r => setTimeout(r, 450));
      }

      const imgs = await Promise.all(shots.map(src => new Promise((resolve, reject) => {
        const im = new Image();
        im.onload = () => resolve(im);
        im.onerror = reject;
        im.src = src;
      })));

      const srcW = imgs[0].naturalWidth;
      const srcH = imgs[0].naturalHeight;

      const pad = 48;
      const gap = 26;
      const frameR = 28;

      const stripW = Math.min(1080, srcW);
      const scale = stripW / srcW;
      const photoH = Math.round(srcH * scale);

      const W = stripW + pad*2;
      const H = pad + (photoH * 4) + (gap * 3) + pad;

      ensureCanvasSize(W, H);

      const bg = ctx.createLinearGradient(0,0,W,H);
      bg.addColorStop(0, 'rgba(6,10,30,1)');
      bg.addColorStop(1, 'rgba(4,6,18,1)');
      ctx.fillStyle = bg;
      ctx.fillRect(0,0,W,H);

      ctx.fillStyle = 'rgba(255,255,255,0.05)';
      roundRect(ctx, 18, 18, W-36, H-36, 34);
      ctx.fill();

      ctx.strokeStyle = 'rgba(255,255,255,0.14)';
      ctx.lineWidth = 2;
      roundRect(ctx, 18, 18, W-36, H-36, 34);
      ctx.stroke();

      let y = pad;
      for (let i=0; i<4; i++){
        ctx.save();
        ctx.shadowColor = 'rgba(0,0,0,0.40)';
        ctx.shadowBlur = 28;
        ctx.shadowOffsetY = 14;
        ctx.fillStyle = 'rgba(0,0,0,0.18)';
        roundRect(ctx, pad, y, stripW, photoH, frameR);
        ctx.fill();
        ctx.restore();

        ctx.save();
        roundRect(ctx, pad, y, stripW, photoH, frameR);
        ctx.clip();

        const im = imgs[i];
        const iw = im.naturalWidth, ih = im.naturalHeight;
        const targetAspect = stripW / photoH;
        const srcAspect = iw / ih;

        let sx=0, sy=0, sw=iw, sh=ih;
        if (srcAspect > targetAspect){
          sw = Math.round(ih * targetAspect);
          sx = Math.round((iw - sw) / 2);
        }else{
          sh = Math.round(iw / targetAspect);
          sy = Math.round((ih - sh) / 2);
        }

        ctx.drawImage(im, sx, sy, sw, sh, pad, y, stripW, photoH);
        ctx.restore();

        ctx.strokeStyle = 'rgba(255,255,255,0.12)';
        ctx.lineWidth = 2;
        roundRect(ctx, pad, y, stripW, photoH, frameR);
        ctx.stroke();

        y += photoH + gap;
      }

      const outPng = els.exportCanvas.toDataURL('image/png');
      addThumb(outPng, '≈ûerit');
      toast('≈ûerit hazƒ±r (d√ºz).');
    }

    function downloadSelectedPNG(){
      if (!selectedId || !items.has(selectedId)) return;
      const { dataURL, label } = items.get(selectedId);
      downloadDataURL(dataURL, `photobooth-${label.toLowerCase()}-${stamp()}.png`);
      toast('PNG indiriliyor‚Ä¶');
    }

    function deleteSelected(){
      if (!selectedId || !items.has(selectedId)) return;
      items.delete(selectedId);
      const el = els.thumbs.querySelector(`[data-id="${CSS.escape(selectedId)}"]`);
      if (el) el.remove();
      selectedId = null;
      updateSelectionUI();
      toast('Se√ßili silindi.');
    }

    function clearAll(){
      items.clear();
      selectedId = null;
      els.thumbs.innerHTML = '';
      updateSelectionUI();
      toast('Galeri temizlendi.');
    }

    els.btnStart.addEventListener('click', startCamera);
    els.btnStop.addEventListener('click', stopCamera);

    els.btnMirror.addEventListener('click', () => {
      mirrored = !mirrored;
      applyMirror();
    });

    els.facing.addEventListener('change', () => {
      if (stream) startCamera();
    });

    els.btnSnap.addEventListener('click', snapSingle);
    els.btnStrip.addEventListener('click', snapStrip);

    els.btnDownloadPng.addEventListener('click', downloadSelectedPNG);
    els.btnDelete.addEventListener('click', deleteSelected);
    els.btnClearAll.addEventListener('click', clearAll);

    window.addEventListener('keydown', (e) => {
      if (e.code === 'Space'){
        e.preventDefault();
        if (!els.btnSnap.disabled) snapSingle();
      }
    });

    setStatus(false, 'Kamera kapalƒ±');
    enableCameraUI(false);
    applyMirror();
    updateSelectionUI();
  </script>
</body>
</html>